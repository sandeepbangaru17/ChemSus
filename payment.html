<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Payment | ChemSus Technologies Pvt Ltd</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="icon" type="image/png" href="assets/logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #0074c7;
      --primary-dark: #00508a;
      --accent: #00b8b0;
      --bg: #F3F7FB;
      --ink: #1f2933;
      --danger: #e53e3e;
    }

    * { box-sizing:border-box; margin:0; padding:0; }

    body {
      font-family:"Open Sans",Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      line-height:1.6;
      display:flex;
      min-height:100vh;
    }

    a { text-decoration:none; color:inherit; }

    /* SIDEBAR (same theme) */
    .sidebar{
      width:240px;
      background:var(--primary);
      color:#fff;
      position:fixed;
      top:0;left:0;
      height:100vh;
      border-right:3px solid var(--accent);
      display:flex;
      flex-direction:column;
    }

    .nav-logo{
      display:flex;
      align-items:center;
      gap:8px;
      padding:16px 20px;
      font-family:"Montserrat",sans-serif;
      font-weight:700;
      border-bottom:1px solid rgba(255,255,255,.15);
    }

    .nav-logo-img{height:24px}

    .nav-menu{list-style:none;padding:10px 0;flex:1;overflow-y:auto;}

    .nav-menu li a{
      display:block;
      padding:10px 20px;
      font-size:14px;
      border-left:3px solid transparent;
      color:#fff;
      transition:.2s;
    }

    .nav-menu li a:hover,
    .nav-menu li a.active{
      background:rgba(255,255,255,.12);
      border-left-color:var(--accent);
    }

    #cart-count {
      background: var(--accent);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 8px;
    }

    /* MAIN WRAPPER */
    .main-wrapper{
      margin-left:240px;
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    /* HERO ‚Äì same dark dotted bg */
    .hero{
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(circle at top left, rgba(0,184,176,0.18), transparent 55%),
        radial-gradient(circle at bottom right, rgba(0,116,199,0.2), transparent 55%),
        #041424;
      color:#ffffff;
      height:220px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      border-top:3px solid var(--accent);
    }

    .hero::before{
      content:"";
      position:absolute;
      inset:0;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,0.08) 0, rgba(255,255,255,0.08) 2px, transparent 3px),
        radial-gradient(circle at 80% 70%, rgba(255,255,255,0.08) 0, rgba(255,255,255,0.08) 2px, transparent 3px);
      background-size:140px 140px;
      opacity:0.6;
      pointer-events:none;
    }

    .hero-content{
      position:relative;
      z-index:1;
      padding:0 18px;
      max-width:720px;
    }

    .hero-kicker{
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      margin-bottom:6px;
      color:#b9e6ff;
    }

    .hero-title{
      font-family:"Montserrat",sans-serif;
      font-size:32px;
      font-weight:700;
      margin-bottom:6px;
    }

    .hero-subtitle{
      font-size:14px;
      color:#e2f3ff;
    }

    /* MAIN CONTENT */
    main{
      max-width:900px;
      margin:0 auto;
      padding:32px 18px 40px 18px;
      width:100%;
      flex:1;
    }

    .payment-card{
      background:#fff;
      padding:28px;
      border-radius:16px;
      box-shadow:0 14px 30px rgba(15,23,42,0.12);
      border-top:4px solid var(--accent);
    }

    .payment-grid{
      display:grid;
      grid-template-columns:1.1fr 1.2fr;
      gap:24px;
    }

    .qr-box{
      text-align:center;
      border-radius:12px;
      background:#f1f5f9;
      padding:20px 16px;
    }

    .qr-box h3{
      font-family:"Montserrat",sans-serif;
      font-size:18px;
      margin-bottom:8px;
      color:#123559;
    }

    .qr-box img{
      width:210px;
      height:210px;
      border-radius:12px;
      background:#fff;
      object-fit:contain;
      box-shadow:0 10px 22px rgba(15,23,42,0.18);
      margin:10px 0;
    }

    .qr-note{
      font-size:13px;
      color:#4b5563;
    }

    .amount-summary{
      margin-top:12px;
      font-size:14px;
      color:#111827;
      font-family:"Montserrat",sans-serif;
    }

    .amount-summary span{
      color:var(--primary-dark);
      font-weight:700;
      font-size:18px;
    }

    /* Receipt upload */
    .section-title{
      font-family:"Montserrat",sans-serif;
      font-size:16px;
      font-weight:600;
      color:#123559;
      margin-bottom:8px;
    }

    .upload-box{
      border:2px dashed #cbd5e1;
      border-radius:12px;
      padding:14px;
      background:#f9fbff;
      text-align:center;
      font-size:13px;
      color:#4b5563;
      margin-bottom:14px;
    }

    .upload-box input[type="file"]{
      display:none;
    }

    .upload-label{
      display:inline-block;
      margin-top:8px;
      padding:8px 16px;
      border-radius:999px;
      background:linear-gradient(135deg,#00b8b0,#0074c7);
      color:#fff;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      transition: all 0.2s ease;
    }

    .upload-label:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    .preview-img{
      margin-top:10px;
      max-width:100%;
      max-height:190px;
      border-radius:8px;
      box-shadow:0 8px 18px rgba(15,23,42,0.18);
      display:none;
    }

    .error-text{
      color:var(--danger);
      font-size:12px;
      margin-top:4px;
      display:none;
    }

    .success-text{
      color:#059669;
      font-size:12px;
      margin-top:4px;
      display:none;
    }

    /* Rating */
    .rating-row{
      margin-top:14px;
    }

    .stars{
      display:flex;
      gap:6px;
      font-size:26px;
      cursor:pointer;
      color:#e5e7eb;
    }

    .star.active{
      color:#facc15;
    }

    .feedback-textarea{
      width:100%;
      margin-top:10px;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-family:inherit;
      font-size:13px;
      min-height:80px;
      outline: none;
    }

    .feedback-textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0,116,199,0.1);
    }

    .actions-row{
      margin-top:20px;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
    }

    .btn-primary{
      background:linear-gradient(135deg,var(--accent),#00d4cc);
      color:#fff;
      border:none;
      border-radius:8px;
      padding:11px 22px;
      font-size:14px;
      font-weight:600;
      font-family:"Montserrat",sans-serif;
      cursor:pointer;
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      filter: brightness(1.05);
      box-shadow: 0 8px 20px rgba(0,184,176,0.3);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary{
      background:transparent;
      color:#123559;
      border-radius:8px;
      padding:10px 18px;
      font-size:13px;
      font-weight:600;
      font-family:"Montserrat",sans-serif;
      border:1px solid #cbd5e1;
      cursor:pointer;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      background: #f1f5f9;
      border-color: var(--primary);
      transform: translateY(-1px);
    }

    footer{
      background:#06121f;
      color:#cbd5f5;
      font-size:13px;
      text-align:center;
      padding:14px 0;
      margin-top:22px;
    }

    .empty-cart-message {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .empty-cart-message h2 {
      font-family: "Montserrat", sans-serif;
      margin-bottom: 12px;
      color: #374151;
      font-size: 24px;
    }

    .empty-cart-message p {
      margin-bottom: 20px;
      font-size: 14px;
    }

    .empty-cart-message a {
      display: inline-block;
      padding: 11px 22px;
      background: linear-gradient(135deg, var(--accent), #00d4cc);
      color: white;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .empty-cart-message a:hover {
      transform: translateY(-2px);
      filter: brightness(1.05);
    }

    @media(max-width:900px){
      .sidebar{display:none;}
      .main-wrapper{margin-left:0;}
      .payment-grid{
        grid-template-columns:1fr;
      }
      .qr-box img{
        width:190px;
        height:190px;
      }
      main {
        padding: 24px 16px 32px 16px;
      }
    }
  </style>
</head>
<body>

<nav class="sidebar">
  <a href="index.html" class="nav-logo">
    <img src="assets/logo.jpg" alt="ChemSus Logo" class="nav-logo-img">
    <span>ChemSus</span>
  </a>
  <ul class="nav-menu">
    <li><a href="index.html">Home</a></li>
    <li><a href="about.html">About Us</a></li>
    <li><a href="products.html">Products</a></li>
    <li><a href="shop.html">Shop</a></li>
    <li><a href="cart.html">Cart üõí <span id="cart-count">0</span></a></li>
    <li><a href="orders.html" class="active">Orders</a></li>
  </ul>
</nav>

<div class="main-wrapper">
  <section class="hero">
    <div class="hero-content">
      <div class="hero-kicker">Secure Payment</div>
      <h1 class="hero-title">Complete Your Payment</h1>
      <p class="hero-subtitle">
        Scan the QR code, upload your payment receipt, and share your experience.
      </p>
    </div>
  </section>

  <main>
    <div class="payment-card" id="paymentForm">
      <div class="payment-grid">
        <!-- LEFT: QR + amount -->
        <div class="qr-box">
          <h3>Scan to Pay</h3>
          <img src="assets/payment-qr.png" alt="Payment QR Code">
          <p class="qr-note">
            Use any UPI / banking app to scan this QR and pay the exact order amount shown below.
          </p>
          <div class="amount-summary">
            Order total: <span id="orderTotalText">‚Çπ0</span>
          </div>
        </div>

        <!-- RIGHT: upload + rating -->
        <div>
          <div class="section-title">Upload payment receipt</div>
          <div class="upload-box">
            <p>Select a screenshot or PDF/image of your successful payment.</p>
            <label class="upload-label" for="receiptInput">Upload receipt</label>
            <input type="file" id="receiptInput" accept="image/*,.pdf">
            <img id="receiptPreview" class="preview-img" alt="Receipt preview">
            <div id="receiptError" class="error-text">Please upload a valid image or PDF receipt.</div>
            <div id="receiptSuccess" class="success-text">‚úì Receipt uploaded successfully!</div>
          </div>

          <div class="section-title">Rate your experience</div>
          <div class="rating-row">
            <div class="stars" id="starContainer">
              <span class="star" data-value="1">‚òÖ</span>
              <span class="star" data-value="2">‚òÖ</span>
              <span class="star" data-value="3">‚òÖ</span>
              <span class="star" data-value="4">‚òÖ</span>
              <span class="star" data-value="5">‚òÖ</span>
            </div>
            <div id="ratingError" class="error-text">Please select a rating from 1 to 5.</div>
            <textarea id="feedbackInput" class="feedback-textarea"
              placeholder="Optional: Tell us about your ChemSus web experience..."></textarea>
          </div>

          <div class="actions-row">
            <button class="btn-primary" id="submitBtn" onclick="confirmPayment()">Confirm payment &amp; finish</button>
            <button class="btn-secondary" onclick="window.location.href='cart.html'">‚Üê Back to Cart</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty cart message -->
    <div class="empty-cart-message" id="emptyMessage" style="display: none;">
      <h2>No items in cart</h2>
      <p>Your cart is empty. Add items from the shop to proceed with payment.</p>
      <a href="shop.html">Go to Shop ‚Üí</a>
    </div>
  </main>

  <footer>
    ¬© 2025 ChemSus Technologies Pvt Ltd. All rights reserved.
  </footer>
</div>

<script>
  // Initialize payment and amount
  function initializePayment() {
    const badge = document.getElementById('cart-count');
    
    // PRIORITY 1: Get total from sessionStorage (set by orders.html BEFORE redirect)
    let total = parseFloat(sessionStorage.getItem('orderTotal')) || 0;
    
    console.log('üí∞ SessionStorage orderTotal:', total);
    
    // PRIORITY 2: If sessionStorage empty, calculate from cart (direct page load)
    if (total === 0) {
      const cart = JSON.parse(localStorage.getItem('chemsusCart')) || [];
      const count = cart.reduce((sum, item) => sum + item.quantity, 0);
      if (badge) badge.textContent = count;
      
      if (cart && cart.length > 0) {
        total = cart.reduce((sum, item) => {
          const price = item.price || item.productPrice || item.pricePerKg || 0;
          const qty = item.quantity || 1;
          return sum + (price * qty);
        }, 0);
        console.log('üì¶ Cart total calculated:', total);
      }
    } else {
      // If we got sessionStorage total, cart is already cleared
      if (badge) badge.textContent = '0';
      console.log('‚úÖ Using sessionStorage total:', total);
    }

    // No amount found at all
    if (total === 0) {
      document.getElementById('paymentForm').style.display = 'none';
      document.getElementById('emptyMessage').style.display = 'block';
      console.log('‚ùå No total found - showing empty message');
      return;
    }
    
    // Display the amount
    const totalElement = document.getElementById('orderTotalText');
    if (totalElement) {
      totalElement.textContent = '‚Çπ' + total.toLocaleString('en-IN');
      console.log('üí≥ Amount displayed:', '‚Çπ' + total.toLocaleString('en-IN'));
    }
  }

  // Receipt preview
  const receiptInput = document.getElementById('receiptInput');
  const receiptPreview = document.getElementById('receiptPreview');
  const receiptError = document.getElementById('receiptError');
  const receiptSuccess = document.getElementById('receiptSuccess');

  receiptInput.addEventListener('change', function (event) {
    const file = event.target.files[0];
    receiptError.style.display = 'none';
    receiptSuccess.style.display = 'none';

    if (!file) {
      receiptPreview.style.display = 'none';
      return;
    }

    const allowed = ['image/', 'application/pdf'];
    if (!allowed.some(t => file.type.startsWith(t))) {
      receiptError.style.display = 'block';
      receiptPreview.style.display = 'none';
      return;
    }

    if (file.type.startsWith('image/')) {
      const url = URL.createObjectURL(file);
      receiptPreview.src = url;
      receiptPreview.style.display = 'block';
      receiptSuccess.style.display = 'block';
    } else {
      receiptPreview.style.display = 'none';
      receiptSuccess.style.display = 'block';
    }
  });

  // Rating stars
  const starContainer = document.getElementById('starContainer');
  const ratingError = document.getElementById('ratingError');
  let selectedRating = 0;

  starContainer.addEventListener('click', function (e) {
    if (!e.target.classList.contains('star')) return;
    selectedRating = parseInt(e.target.getAttribute('data-value'), 10);
    document.querySelectorAll('.star').forEach(star => {
      const v = parseInt(star.getAttribute('data-value'), 10);
      star.classList.toggle('active', v <= selectedRating);
    });
    ratingError.style.display = 'none';
  });

  async function confirmPayment() {
    const submitBtn = document.getElementById('submitBtn');
    const file = receiptInput.files[0];
    const cartTotal = parseFloat(sessionStorage.getItem('orderTotal')) || 0;
    let hasError = false;

    if (!file) {
      receiptError.textContent = 'Please upload your payment receipt.';
      receiptError.style.display = 'block';
      hasError = true;
    }

    if (!selectedRating) {
      ratingError.style.display = 'block';
      hasError = true;
    }

    if (hasError) return;

    try {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';

      const feedback = document.getElementById('feedbackInput').value.trim();
      const cart = JSON.parse(localStorage.getItem('chemsusCart')) || [];

      // Get order ID from sessionStorage or use 1 as default
      const orderId = sessionStorage.getItem('orderId') || 1;
      
      // Get customer info from cart order details or use defaults
      let customerName = 'Customer';
      let customerEmail = 'customer@example.com';
      let customerPhone = '0000000000';
      let orderAmount = cartTotal;

      const orderDetails = sessionStorage.getItem('orderDetails');
      if (orderDetails) {
        try {
          const details = JSON.parse(orderDetails);
          customerName = details.fullName || customerName;
          customerEmail = details.email || customerEmail;
          customerPhone = details.mobile || customerPhone;
        } catch (e) {
          console.log('Could not parse order details');
        }
      }

      // Calculate total if not available
      if (orderAmount === 0 && cart.length > 0) {
        orderAmount = cart.reduce((sum, item) => {
          const price = item.price || item.productPrice || item.pricePerKg || 0;
          const qty = item.quantity || 1;
          return sum + (price * qty);
        }, 0);
      }

      // ‚úÖ Upload receipt to backend
      const formData = new FormData();
      formData.append('orderid', orderId);
      formData.append('customername', customerName);
      formData.append('email', customerEmail);
      formData.append('phone', customerPhone);
      formData.append('amount', orderAmount);
      formData.append('rating', selectedRating);
      formData.append('feedback', feedback || null);
      formData.append('receiptimage', file);

      console.log('üì§ Uploading receipt with:', {
        orderid: orderId,
        customername: customerName,
        email: customerEmail,
        phone: customerPhone,
        amount: orderAmount,
        rating: selectedRating
      });

      const receiptResponse = await fetch('http://localhost:3000/api/receipts', {
        method: 'POST',
        body: formData,
      });

      if (!receiptResponse.ok) {
        throw new Error('Failed to upload receipt to backend');
      }

      const receiptResult = await receiptResponse.json();
      console.log('‚úÖ Receipt uploaded successfully:', receiptResult);

      // Store payment confirmation data
      const paymentInfo = {
        hasReceipt: !!file,
        rating: selectedRating,
        feedback: feedback,
        receiptId: receiptResult.receiptId,
        confirmedAt: new Date().toISOString()
      };
      localStorage.setItem('chemsusPaymentInfo', JSON.stringify(paymentInfo));

      alert('‚úÖ Thank you! Your payment receipt has been uploaded and feedback recorded.');
      
      // Clear cart after successful payment
      localStorage.removeItem('chemsusCart');
      sessionStorage.removeItem('orderTotal');
      sessionStorage.removeItem('orderDetails');
      sessionStorage.removeItem('orderId');
      
      window.location.href = 'orders.html';

    } catch (error) {
      console.error('‚ùå Payment error:', error);
      receiptError.textContent = '‚ùå Error: ' + error.message + '. Check if backend is running.';
      receiptError.style.display = 'block';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Confirm payment & finish';
    }
  }

  // Initialize on page load
  window.addEventListener('load', initializePayment);
</script>

</body>
</html>
